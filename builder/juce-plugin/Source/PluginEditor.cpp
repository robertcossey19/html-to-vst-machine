#include "PluginEditor.h"

// BinaryData.h is generated by the HtmlUIData target
#include "BinaryData.h"

using namespace juce;

static const char* kFallbackHtml = R"HTML(
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>HTML to VST</title>
<style>
  :root{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background:#0b0f16; color:#e6edf7;
    --juce-vu-l: 0; --juce-vu-r: 0;
  }
  .wrap{padding:18px}
  .row{display:flex;gap:18px;align-items:center;flex-wrap:wrap}
  .card{background:#111827;border:1px solid #243047;border-radius:14px;padding:14px;min-width:260px}
  label{display:block;font-size:12px;opacity:.85;margin-bottom:8px}
  input[type=range]{width:240px}
  .meter{height:12px;width:240px;border-radius:999px;background:#1f2937;overflow:hidden}
  .fill{height:100%;width:0%}
  .fillL{width:calc(var(--juce-vu-l) * 100%);background:#22c55e}
  .fillR{width:calc(var(--juce-vu-r) * 100%);background:#60a5fa}
  button{padding:10px 12px;border-radius:12px;border:1px solid #2b3445;background:#0f172a;color:#e6edf7}
</style>
</head>
<body>
<div class="wrap">
  <h2>HTML to VST (Fallback UI)</h2>
  <div class="row">
    <div class="card">
      <label>Input Gain (dB)</label>
      <input id="inGainDb" type="range" min="-24" max="24" step="0.01" value="0"/>
    </div>
    <div class="card">
      <label>Output Gain (dB)</label>
      <input id="outGainDb" type="range" min="-24" max="24" step="0.01" value="0"/>
    </div>
    <div class="card">
      <label>Transformer</label>
      <input id="transformerOn" type="checkbox" checked/>
    </div>
  </div>

  <div style="height:14px"></div>
  <div class="row">
    <div class="card">
      <label>VU L</label>
      <div class="meter"><div class="fill fillL"></div></div>
    </div>
    <div class="card">
      <label>VU R</label>
      <div class="meter"><div class="fill fillR"></div></div>
    </div>
  </div>
</div>

<script>
  // Basic sender for fallback UI
  function send(id, v){
    try{
      location.href = 'juce://param?id=' + encodeURIComponent(id) + '&value=' + encodeURIComponent(v);
    }catch(e){}
  }
  document.addEventListener('input', (e)=>{
    const el = e.target;
    if(!el || !el.id) return;
    if(el.type === 'checkbox') send(el.id, el.checked ? 1 : 0);
    else send(el.id, el.value);
  }, true);

  window.__juceUpdateVU = function(lNorm, rNorm){
    document.documentElement.style.setProperty('--juce-vu-l', lNorm);
    document.documentElement.style.setProperty('--juce-vu-r', rNorm);
  };
</script>
</body>
</html>
)HTML";

HtmlToVstAudioProcessorEditor::HtmlToVstAudioProcessorEditor (HtmlToVstAudioProcessor& p)
    : AudioProcessorEditor (&p),
      processor (p),
      webView()
{
    setOpaque (true);
    setSize (980, 620);

    addAndMakeVisible (webView);
    webView.addListener (this);

    ensureHtmlReady();

    // 30 Hz UI updates (meters + param sync)
    startTimerHz (30);
}

HtmlToVstAudioProcessorEditor::~HtmlToVstAudioProcessorEditor()
{
    webView.removeListener (this);
}

void HtmlToVstAudioProcessorEditor::paint (Graphics& g)
{
    g.fillAll (Colours::black);
}

void HtmlToVstAudioProcessorEditor::resized()
{
    webView.setBounds (getLocalBounds());
}

void HtmlToVstAudioProcessorEditor::ensureHtmlReady()
{
    if (htmlReady)
        return;

    tempDir = File::getSpecialLocation (File::tempDirectory)
                .getChildFile ("html-to-vst-machine");
    tempDir.createDirectory();

    tempHtmlFile = tempDir.getChildFile ("index.html");

    int dataSize = 0;
    const char* data = nullptr;

    // Try common BinaryData names (works whether you embedded "index.html" or "ui/index.html", etc.)
    const char* candidates[] = {
        "index.html",
        "index.htm",
        "ui/index.html",
        "web/index.html",
        "dist/index.html",
        "build/index.html",
        "public/index.html"
    };

    for (auto* name : candidates)
    {
        data = BinaryData::getNamedResource (name, dataSize);
        if (data != nullptr && dataSize > 0)
            break;
    }

    if (data != nullptr && dataSize > 0)
        tempHtmlFile.replaceWithData (data, (size_t) dataSize);
    else
        tempHtmlFile.replaceWithText (kFallbackHtml);

    const auto url = URL (tempHtmlFile)
                        .withParameter ("t", String (Time::getMillisecondCounter()))
                        .toString (true);

    webView.goToURL (url);
    htmlReady = true;
}

bool HtmlToVstAudioProcessorEditor::pageAboutToLoad (const String& newURL)
{
    // Catch UI -> JUCE messages
    if (! newURL.startsWithIgnoreCase ("juce:") && ! newURL.startsWithIgnoreCase ("juce://"))
        return true;

    // Remove scheme
    auto s = newURL;
    if (s.startsWithIgnoreCase ("juce://"))
        s = s.substring (7);
    else
        s = s.fromFirstOccurrenceOf ("juce:", false, false);

    if (s.startsWith ("//"))
        s = s.substring (2);

    const auto path  = s.upToFirstOccurrenceOf ("?", false, false).trim();
    const auto query = s.fromFirstOccurrenceOf ("?", false, false).trim();

    String paramId;
    String valueStr;

    if (query.isNotEmpty())
    {
        StringArray parts;
        parts.addTokens (query, "&", "");

        for (auto part : parts)
        {
            part = part.trim();
            const auto key = part.upToFirstOccurrenceOf ("=", false, false).trim();
            const auto val = URL::removeEscapeChars (part.fromFirstOccurrenceOf ("=", false, false).trim());

            if (key.equalsIgnoreCase ("id") || key.equalsIgnoreCase ("param") || key.equalsIgnoreCase ("name"))
                paramId = val;
            else if (key.equalsIgnoreCase ("value") || key.equalsIgnoreCase ("v"))
                valueStr = val;
        }
    }

    // If no explicit id=, treat path itself as the param name (unless it's just "param")
    if (paramId.isEmpty())
    {
        if (path.isNotEmpty() && path != "param" && path != "set" && path != "setparam")
            paramId = URL::removeEscapeChars (path);
    }

    if (paramId.isNotEmpty() && valueStr.isNotEmpty())
        processor.setParameterFromUI (paramId, valueStr.getFloatValue());

    // Stop the browser from actually navigating away
    return false;
}

void HtmlToVstAudioProcessorEditor::ensureBridgeInjected()
{
    if (bridgeInjected)
        return;

    // Generic bridge:
    // - listens to any <input>/<select> changes and sends juce://param?id=...&value=...
    // - defines __juceUpdateVU() hook + CSS vars + events for meters
    // - listens for juce-params event to force UI state (fixes "transformer stays on" type issues)
    const String js =
        "javascript:(function(){"
        " if(window.__juceBridgeInstalled) return;"
        " window.__juceBridgeInstalled = true;"

        " function send(id,v){"
        "   try{"
        "     var url='juce://param?id='+encodeURIComponent(id)+'&value='+encodeURIComponent(v);"
        "     window.location.href=url;"
        "   }catch(e){}"
        " }"
        " window.__juceSendParam = send;"

        " function pickId(el){"
        "   return (el.getAttribute('data-param')||el.getAttribute('data-juce-param')||el.id||el.name||'').toString();"
        " }"
        " function pickValue(el){"
        "   if(!el) return 0;"
        "   if(el.type==='checkbox' || el.type==='radio') return el.checked?1:0;"
        "   var v = (el.value!=null?el.value:el.getAttribute('value'));"
        "   var f = parseFloat(v);"
        "   return (isFinite(f)?f:v);"
        " }"

        " document.addEventListener('input', function(e){"
        "   var el=e.target; if(!el) return;"
        "   var id=pickId(el); if(!id) return;"
        "   send(id, pickValue(el));"
        " }, true);"

        " document.addEventListener('change', function(e){"
        "   var el=e.target; if(!el) return;"
        "   var id=pickId(el); if(!id) return;"
        "   send(id, pickValue(el));"
        " }, true);"

        " window.__juceUpdateVU = function(lNorm,rNorm,lDb,rDb){"
        "   try{"
        "     document.documentElement.style.setProperty('--juce-vu-l', lNorm);"
        "     document.documentElement.style.setProperty('--juce-vu-r', rNorm);"
        "     document.documentElement.style.setProperty('--juce-vu-l-db', lDb);"
        "     document.documentElement.style.setProperty('--juce-vu-r-db', rDb);"
        "     window.dispatchEvent(new CustomEvent('juce-vu', {detail:{l:lNorm,r:rNorm,ldb:lDb,rdb:rDb}}));"
        "   }catch(e){}"
        " };"

        " window.addEventListener('juce-params', function(ev){"
        "   try{"
        "     var d = (ev && ev.detail) ? ev.detail : {};"
        "     // Force checkbox/toggle state for transformer if present"
        "     var t = d.transformerOn;"
        "     if(typeof t !== 'undefined'){"
        "       var els = document.querySelectorAll('[data-param*=transform],[data-juce-param*=transform],#transformerOn,#transformer');"
        "       els.forEach(function(el){"
        "         if(el.type==='checkbox') el.checked = !!t;"
        "         el.setAttribute('aria-pressed', (!!t).toString());"
        "       });"
        "     }"
        "   }catch(e){}"
        " });"

        "})();";

    webView.goToURL (js);
    bridgeInjected = true;
}

void HtmlToVstAudioProcessorEditor::timerCallback()
{
    ensureHtmlReady();
    ensureBridgeInjected();

    // meters in dB (from processor) -> normalized 0..1 where -60dB => 0, 0dB => 1
    const float lDb = processor.getVUL();
    const float rDb = processor.getVUR();

    const float lNorm = jlimit (0.0f, 1.0f, (lDb + 60.0f) / 60.0f);
    const float rNorm = jlimit (0.0f, 1.0f, (rDb + 60.0f) / 60.0f);

    // Also push param values back into UI to keep toggle state correct
    auto& apvts = processor.getAPVTS();
    const float inDb  = apvts.getRawParameterValue ("inGainDb")->load();
    const float outDb = apvts.getRawParameterValue ("outGainDb")->load();
    const float trOn  = apvts.getRawParameterValue ("transformerOn")->load();

    // 1) Update meters via hook + CSS vars + event
    String jsVU;
    jsVU << "javascript:(function(){try{"
         << "if(window.__juceUpdateVU) window.__juceUpdateVU("
         << String (lNorm, 6) << "," << String (rNorm, 6) << ","
         << String (lDb, 2)   << "," << String (rDb, 2)   << ");"
         << "}catch(e){}})();";
    webView.goToURL (jsVU);

    // 2) Push params back (fixes "transformer stays on/off" visuals)
    String jsParams;
    jsParams << "javascript:(function(){try{"
             << "window.dispatchEvent(new CustomEvent('juce-params',{detail:{"
             << "inGainDb:" << String (inDb, 3) << ","
             << "outGainDb:" << String (outDb, 3) << ","
             << "transformerOn:" << String (trOn > 0.5f ? 1 : 0)
             << "}}));"
             << "}catch(e){}})();";
    webView.goToURL (jsParams);
}
