#include "PluginEditor.h"
#include "PluginProcessor.h"

#if __has_include("BinaryData.h")
  #include "BinaryData.h"
#elif __has_include(<BinaryData.h>)
  #include <BinaryData.h>
#endif

// IMPORTANT:
// - `defined(BinaryData::something)` is illegal (defined() only works with macros).
// - BinaryData::getNamedResource is generated by JUCE binary data (when enabled).
// - If binary data isn't enabled, we simply return false.

static bool binaryDataHasResource (const char* name, int& sizeOut)
{
    sizeOut = 0;

   #if defined(JUCE_TARGET_HAS_BINARY_DATA) && JUCE_TARGET_HAS_BINARY_DATA
    // getNamedResource returns nullptr if not found
    if (auto* data = BinaryData::getNamedResource (name, sizeOut))
        return data != nullptr;
   #endif

    (void) name;
    return false;
}

static juce::String loadHtmlFromBinaryDataOrFallback()
{
   #if defined(JUCE_TARGET_HAS_BINARY_DATA) && JUCE_TARGET_HAS_BINARY_DATA
    int size = 0;

    // Try common names you may have embedded (adjust your generator to match ONE of these).
    // These are just lookups; if not found, it falls back cleanly.
    const char* candidates[] = {
        "index_html",
        "index.html",
        "ui_html",
        "ui.html",
        "main_html",
        "main.html"
    };

    for (auto* c : candidates)
    {
        if (binaryDataHasResource (c, size))
        {
            if (auto* data = BinaryData::getNamedResource (c, size))
                return juce::String::fromUTF8 ((const char*) data, size);
        }
    }
   #endif

    // Fallback: minimal page so the plugin always shows something
    return R"HTML(
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HTML to VST</title>
  <style>
    body{margin:0;background:#111;color:#eee;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{padding:16px}
    code{background:#222;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>HTML UI not embedded</h2>
    <p>No <code>BinaryData</code> resource matched (index.html/ui.html/etc).</p>
    <p>Embed an HTML file into the HtmlUIData target and name it <code>index.html</code> (recommended).</p>
  </div>
</body>
</html>
)HTML";
}

HtmlToVstPluginAudioProcessorEditor::HtmlToVstPluginAudioProcessorEditor (HtmlToVstPluginAudioProcessor& p)
    : AudioProcessorEditor (&p)
    , audioProcessor (p)
{
    setOpaque (true);

    // Your project appears to be built with JUCE_WEB_BROWSER=1
    // so WebBrowserComponent should be available.
    addAndMakeVisible (browser);

    browser.goToURL (juce::URL ("data:text/html;charset=utf-8," + juce::URL::addEscapeChars (loadHtmlFromBinaryDataOrFallback(), true)));
    setSize (1000, 650);
}

HtmlToVstPluginAudioProcessorEditor::~HtmlToVstPluginAudioProcessorEditor() = default;

void HtmlToVstPluginAudioProcessorEditor::paint (juce::Graphics& g)
{
    g.fillAll (juce::Colours::black);
}

void HtmlToVstPluginAudioProcessorEditor::resized()
{
    browser.setBounds (getLocalBounds());
}
