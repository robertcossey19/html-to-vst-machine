#include "PluginEditor.h"
#include "BinaryData.h"   // generated by juce_add_binary_data(HtmlUIData ...)

using namespace juce;

HtmlToVstAudioProcessorEditor::HtmlToVstAudioProcessorEditor (HtmlToVstAudioProcessor& p)
    : AudioProcessorEditor (&p),
      processor (p)
{
    // Load HTML from BinaryData
    const auto* htmlData = BinaryData::ampex_ui_html;
    const int   htmlSize = BinaryData::ampex_ui_htmlSize;

    String html (String::fromUTF8 (htmlData, htmlSize));

    // Make sure we inject a JS hook that the C++ side can call:
    // window.setVUmeter(lDb, rDb) â†’ moves the needles.
    const char* vuScript = R"JS(
        <script>
        (function(){
          window.setVUmeter = function(lDb, rDb){
            function dbToDeg(db){
              // same mapping as Web version: -70..+20 -> -70..+20-ish
              var clamped = Math.max(-70, Math.min(20, db));
              return (clamped + 50) * 2.25 - 70;
            }
            var vuL = document.getElementById('vuL');
            var vuR = document.getElementById('vuR');
            if (vuL) vuL.style.transform = 'rotate(' + dbToDeg(lDb).toFixed(1) + 'deg)';
            if (vuR) vuR.style.transform = 'rotate(' + dbToDeg(rDb).toFixed(1) + 'deg)';
          };
        })();
        </script>
    )JS";

    // Inject script just before </body> so DOM elements exist.
    html = html.replace ("</body>", String (vuScript) + "\n</body>");

    webView.setOpaque (false);
    webView.setSize (800, 600);

    // Load HTML via data URL
    auto encoded = URL::addEscapeChars (html, true);
    auto dataUrl = "data:text/html;charset=utf-8," + encoded;
    webView.goToURL (dataUrl);

    addAndMakeVisible (webView);

    setSize (900, 650);

    // Poll VU at ~30 Hz
    startTimerHz (30);
}

HtmlToVstAudioProcessorEditor::~HtmlToVstAudioProcessorEditor()
{
    stopTimer();
}

void HtmlToVstAudioProcessorEditor::paint (Graphics& g)
{
    g.fillAll (Colours::black);
}

void HtmlToVstAudioProcessorEditor::resized()
{
    webView.setBounds (getLocalBounds());
}

void HtmlToVstAudioProcessorEditor::timerCallback()
{
    const float vuL = processor.getCurrentVUL();
    const float vuR = processor.getCurrentVUR();

    // Call the JS hook we injected (window.setVUmeter)
    const auto js = "window.setVUmeter("
                  + String (vuL, 2) + ","
                  + String (vuR, 2) + ");";

    webView.evaluateJavascript (js, nullptr);
}
