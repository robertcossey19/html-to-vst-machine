cmake_minimum_required(VERSION 3.20)
project(HtmlToVstPlugin VERSION 1.0.0)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# -------------------------
# JUCE (FetchContent)
# -------------------------
include(FetchContent)

# If you already vendor JUCE somewhere else, keep this as-is or point to your local JUCE.
FetchContent_Declare(
  JUCE
  GIT_REPOSITORY https://github.com/juce-framework/JUCE.git
  GIT_TAG        8.0.9
)
FetchContent_MakeAvailable(JUCE)

# -------------------------
# UI BinaryData (EXPLICIT)
# -------------------------
set(UI_HTML "${CMAKE_CURRENT_LIST_DIR}/Assets/UI/ampex_ui.html")

# IMPORTANT: If this path is wrong in CI, JUCE's binarydata generator can crash at build time.
# We fail early so you see the real problem immediately.
if(NOT EXISTS "${UI_HTML}")
  message(FATAL_ERROR
    "UI HTML not found: ${UI_HTML}\n"
    "Fix the path or add the file to the repo at builder/juce-plugin/Assets/UI/ampex_ui.html"
  )
endif()

juce_add_binary_data(HtmlUIData SOURCES "${UI_HTML}")

# -------------------------
# Plugin Target
# -------------------------
juce_add_plugin(HtmlToVstPlugin
  COMPANY_NAME "AnalogExact"
  PRODUCT_NAME "HTMLtoVST"                     # no spaces (avoids odd build-script edge cases)
  PLUGIN_MANUFACTURER_CODE Manu
  PLUGIN_CODE Lbir
  FORMATS VST3
  IS_SYNTH FALSE
  NEEDS_MIDI_INPUT FALSE
  NEEDS_MIDI_OUTPUT FALSE
  IS_MIDI_EFFECT FALSE
  EDITOR_WANTS_KEYBOARD_FOCUS FALSE
  COPY_PLUGIN_AFTER_BUILD FALSE
)

target_sources(HtmlToVstPlugin PRIVATE
  Source/PluginProcessor.cpp
  Source/PluginProcessor.h
  Source/PluginEditor.cpp
  Source/PluginEditor.h
)

target_link_libraries(HtmlToVstPlugin PRIVATE
  HtmlUIData
  juce::juce_audio_utils
  juce::juce_gui_extra
  juce::juce_dsp
  juce::juce_recommended_config_flags
  juce::juce_recommended_lto_flags
  juce::juce_recommended_warning_flags
)

# -------------------------
# DEFINES / FIXES FOR YOUR LOG ERRORS
# -------------------------
# 1) Fix JUCE's VST2/VST3 param automation conflict compile-time #error
#    by forcing legacy parameter IDs and disabling VST3 replacing VST2.
#
# 2) Also ensure binarydata is enabled for the target.
target_compile_definitions(HtmlToVstPlugin PRIVATE
  JUCE_WEB_BROWSER=1
  JUCE_USE_CURL=0

  JUCE_TARGET_HAS_BINARY_DATA=1

  JUCE_FORCE_USE_LEGACY_PARAM_IDS=1
  JUCE_VST3_CAN_REPLACE_VST2=0
)

# Make sure the *bundle identifiers* are consistent (you already moved to com.analogexact.htmltovst in logs)
set_target_properties(HtmlToVstPlugin PROPERTIES
  JUCE_BUNDLE_ID "com.analogexact.htmltovst"
)

# If you have a separate helper target generated by JUCE/CMake,
# it will inherit the relevant defines via shared code; but we can be explicit too:
if(TARGET HtmlToVstPlugin_SharedCode)
  target_compile_definitions(HtmlToVstPlugin_SharedCode PRIVATE
    JUCE_FORCE_USE_LEGACY_PARAM_IDS=1
    JUCE_VST3_CAN_REPLACE_VST2=0
    JUCE_TARGET_HAS_BINARY_DATA=1
  )
endif()
