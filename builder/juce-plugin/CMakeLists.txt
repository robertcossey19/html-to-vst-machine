cmake_minimum_required(VERSION 3.21)
project(HtmlToVstPlugin VERSION 1.0.0)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# -------------------------
# JUCE (CPM)
# -------------------------
include(FetchContent)

FetchContent_Declare(
  juce
  GIT_REPOSITORY https://github.com/juce-framework/JUCE.git
  GIT_TAG 8.0.6
)
FetchContent_MakeAvailable(juce)

# -------------------------
# UI file (repo-root/ui/index.html)
# If missing, generate a safe fallback so BinaryData generation can't crash.
# -------------------------
set(UI_DIR "${CMAKE_CURRENT_LIST_DIR}/../../ui")
set(UI_ENTRY "${UI_DIR}/index.html")

if (NOT EXISTS "${UI_ENTRY}")
  message(WARNING "UI file not found: ${UI_ENTRY}\nGenerating fallback UI so BinaryData generation won't crash.")
  file(MAKE_DIRECTORY "${UI_DIR}")
  file(WRITE "${UI_ENTRY}" "<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>HTMLtoVST</title></head><body style='font-family:system-ui;margin:20px'><h2>HTMLtoVST</h2><p>Fallback UI generated by CMake because ui/index.html was missing.</p></body></html>")
endif()

# -------------------------
# BinaryData target for the UI
# -------------------------
juce_add_binary_data(HtmlUIData SOURCES "${UI_ENTRY}")

# -------------------------
# Plugin
# -------------------------
juce_add_plugin(HtmlToVstPlugin
  COMPANY_NAME "AnalogExact"
  BUNDLE_ID "com.analogexact.htmltovst"
  IS_SYNTH FALSE
  NEEDS_MIDI_INPUT FALSE
  NEEDS_MIDI_OUTPUT FALSE
  IS_MIDI_EFFECT FALSE
  EDITOR_WANTS_KEYBOARD_FOCUS FALSE
  PLUGIN_MANUFACTURER_CODE Manu
  PLUGIN_CODE Lbir
  FORMATS VST3
  PRODUCT_NAME "HTMLtoVST"
)

target_sources(HtmlToVstPlugin PRIVATE
  Source/PluginProcessor.cpp
  Source/PluginEditor.cpp
)

target_link_libraries(HtmlToVstPlugin
  PRIVATE
    HtmlUIData
    juce::juce_audio_utils
    juce::juce_audio_processors
    juce::juce_gui_extra
    juce::juce_gui_basics
    juce::juce_graphics
    juce::juce_events
    juce::juce_data_structures
    juce::juce_core
  PUBLIC
    juce::juce_recommended_config_flags
    juce::juce_recommended_lto_flags
    juce::juce_recommended_warning_flags
)

# Let the plugin see BinaryData.h (generated by HtmlUIData)
target_include_directories(HtmlToVstPlugin PRIVATE
  "${CMAKE_CURRENT_BINARY_DIR}/juce_binarydata_HtmlUIData/JuceLibraryCode"
)

# Basic compile defs
target_compile_definitions(HtmlToVstPlugin PRIVATE
  JUCE_WEB_BROWSER=1
  JUCE_USE_CURL=0
)

# Silence super strict warning sets in CI if needed
if (APPLE)
  target_compile_options(HtmlToVstPlugin PRIVATE -Wno-pedantic -Wno-shadow -Wno-zero-as-null-pointer-constant)
endif()
