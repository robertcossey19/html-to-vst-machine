<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ANALOGEXACT – ATR-102 UI</title>

<!-- Tailwind + Fonts -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">

<style>
  html,body { height:100%; background:#1a202c; }
  body { font-family:'Inter',sans-serif; color:#e5e7eb; }

  .metal-panel { background:linear-gradient(145deg,#4a5568,#3a4454); border:1px solid #718096; border-top-color:#a0aec0; }

  .module-bg { background:rgba(0,0,0,.2); border:1px solid rgba(0,0,0,.4); box-shadow:inset 0 2px 6px rgba(0,0,0,.4); }

  .knob { position:relative; width:80px; height:80px; border-radius:50%; background:linear-gradient(145deg,#5a6578,#2d3748);
          border:2px solid #1a202c; box-shadow:0 5px 10px rgba(0,0,0,.5),inset 0 2px 3px rgba(255,255,255,.08);
          display:flex; align-items:center; justify-content:center; cursor:pointer; user-select:none; touch-action:none; }
  .knob-ind { position:absolute; width:4px; height:12px; background:#e2e8f0; top:6px; border-radius:2px;
              transform-origin:center 34px; box-shadow:0 0 3px rgba(255,255,255,.5); }

  .vu-housing { background:#111827; border:4px solid #4b5563; border-radius:10px; padding:12px;
                box-shadow:inset 0 0 20px rgba(0,0,0,.8); }

  .vu-scale { position:relative; width:100%; height:60px; background:#ffebcd; border-radius:4px; overflow:hidden; }
  .vu-needle { position:absolute; width:2px; height:100%; background:#dc2626; bottom:0; left:50%;
               transform-origin:bottom center; transition:transform .04s linear; box-shadow:0 0 5px #dc2626; }
  .vu-dim { opacity:.35; filter:grayscale(.3); }

  .switch-group button.active { background:#f6ad55; color:#1a202c; font-weight:700; box-shadow:inset 0 2px 4px rgba(0,0,0,.4); }

  #tech-panel { transition:max-height .5s ease, opacity .4s ease, transform .4s ease; transform:scaleY(.98); }
  #tech-panel.open { transform:scaleY(1); }

  .collapsible { transition:max-height .35s ease, opacity .25s ease, transform .25s ease; overflow:hidden; }
  .collapsible.hidden-state { max-height:0; opacity:0; transform:translateY(-4px); pointer-events:none; }

  .toggle-switch { display:inline-block; width:50px; height:26px; background:#4a5568; border-radius:13px; cursor:pointer;
                   position:relative; border:1px solid #1a202c; }
  .toggle-switch.active { background:#f6ad55; }
  .toggle-switch-handle { position:absolute; top:2px; left:2px; width:20px; height:20px; background:#fff; border-radius:50%;
                          box-shadow:0 1px 3px rgba(0,0,0,.4); transition:transform .2s; }
  .toggle-switch.active .toggle-switch-handle { transform:translateX(24px); }

</style>
</head>

<body class="flex items-center justify-center min-h-screen p-3">
<div class="metal-panel rounded-2xl p-4 md:p-6 w-full max-w-6xl space-y-4">

    <!-- HEADER -->
    <div class="flex justify-between items-center pb-3 border-b border-black/30">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-white tracking-wider">ANALOGEXACT</h1>
            <p class="text-sm text-gray-400">
                ATR-102 • 768 kHz oversampling • Non-linear magnetic core • Transformer I/O
            </p>
        </div>
    </div>

    <!-- METERS -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div id="vuLwrap" class="vu-housing">
            <div class="flex items-center justify-between text-xs text-gray-700 mb-1">
                <span class="text-gray-300">VU - L</span>
                <span class="text-gray-500">-20  -10   0   +3  +5</span>
            </div>
            <div class="vu-scale"><div id="vuL" class="vu-needle" style="transform:rotate(-70deg)"></div></div>
        </div>

        <div id="vuRwrap" class="vu-housing">
            <div class="flex items-center justify-between text-xs text-gray-700 mb-1">
                <span class="text-gray-300">VU - R</span>
                <span class="text-gray-500">-20  -10   0   +3  +5</span>
            </div>
            <div class="vu-scale"><div id="vuR" class="vu-needle" style="transform:rotate(-70deg)"></div></div>
        </div>
    </div>

    <!-- INPUT / OUTPUT / MONITOR -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

        <div class="module-bg p-4 rounded-lg space-y-3 flex flex-col items-center">
            <h2 class="text-lg font-bold">INPUT LEVEL</h2>
            <div class="knob" id="knob-in"><div class="knob-ind"></div></div>
            <span id="val-in" class="font-mono text-sm text-yellow-300">0.0 dB</span>
        </div>

        <div class="module-bg p-4 rounded-lg space-y-3 flex flex-col items-center">
            <h2 class="text-lg font-bold">OUTPUT LEVEL</h2>
            <div class="knob" id="knob-out"><div class="knob-ind"></div></div>
            <span id="val-out" class="font-mono text-sm text-yellow-300">0.0 dB</span>
        </div>

        <div class="module-bg p-4 rounded-lg space-y-3 flex flex-col items-center">
            <h2 class="text-lg font-bold">MONITOR</h2>
            <div id="monitor" class="switch-group flex rounded-md bg-gray-900 p-1 w-full">
                <button data-monitor="input" class="flex-1 py-2 rounded text-sm font-medium active">INPUT</button>
                <button data-monitor="repro" class="flex-1 py-2 rounded text-sm font-medium">REPRO</button>
            </div>
        </div>

    </div>

    <!-- HEADBLOCK -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="module-bg p-4 rounded-lg space-y-3 flex flex-col items-center">
            <h2 class="text-lg font-bold mb-2">HEADBLOCK</h2>
            <div id="headblock" class="switch-group flex rounded-md bg-gray-900 p-1 w-full">
                <button data-headblock="stereo" class="flex-1 py-2 rounded text-sm font-medium active">STEREO 2-TRK</button>
                <button data-headblock="mono"   class="flex-1 py-2 rounded text-sm font-medium">FULL-TRACK MONO</button>
            </div>
            <p id="headblock-note" class="text-[11px] text-gray-400 text-center">
                Stereo 2-track headblock active.
            </p>
        </div>
    </div>

    <!-- TECH PANEL TOGGLES (still allowed) -->
    <div class="text-center pt-1">
        <button id="toggle-tech" class="text-yellow-400 hover:text-yellow-300 font-semibold text-sm">
            Technician’s Setup Panel ▼
        </button>
    </div>

    <div id="tech-panel" class="max-h-0 opacity-0 overflow-hidden module-bg p-4 rounded-lg space-y-6">

        <h3 class="text-center font-bold text-lg text-yellow-400">INTERNAL CALIBRATION & TAPE FORMULA</h3>

        <!-- Bias / Transformer / EQ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-y-4 text-center border-b border-gray-600 pb-4">

            <div class="space-y-2">
                <label class="font-semibold block">BIAS ADJUST</label>
                <p class="text-xs text-gray-400">Main Audio PWA</p>
                <div class="knob mx-auto mt-2" id="knob-bias" style="width:60px;height:60px;">
                    <div class="knob-ind" style="transform-origin:center 25px;"></div>
                </div>
                <span id="val-bias" class="font-mono text-xs">+0.0 dB</span>
            </div>

            <div class="space-y-2 flex flex-col justify-center pt-8">
                <label class="font-semibold block">XFORMER I/O</label>
                <div class="flex justify-center mt-auto mb-auto pt-2">
                    <div id="transformer" class="toggle-switch active">
                        <div class="toggle-switch-handle"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-2 flex flex-col justify-center pt-8">
                <div class="flex items-center justify-between mb-2">
                    <label class="font-semibold block">EQ STANDARD</label>
                    <button id="eq-legend-toggle" class="text-xs px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-white">
                        Learn More
                    </button>
                </div>

                <div id="eq" class="switch-group flex rounded-md bg-gray-900 p-1 mx-auto">
                    <button data-eq="NAB" class="flex-1 py-1 rounded text-xs font-medium active">NAB</button>
                    <button data-eq="IEC" class="flex-1 py-1 rounded text-xs font-medium">IEC/CCIR</button>
                </div>

                <div id="eq-legend" class="collapsible hidden-state mt-3 text-left bg-gray-800/70 border border-gray-700 rounded-lg p-3 space-y-3 text-sm">
                    <p class="text-yellow-300 font-semibold">How EQ standard changes tone with speed.</p>
                    <p><b>NAB 15ips</b> – balanced classic alignment<br/>
                       <b>IEC 30ips</b> – minimal head bump</p>
                </div>
            </div>

        </div>

        <!-- SPEED / FLUX / TAPE -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">

            <div>
                <label class="font-semibold mb-2 block">SPEED (IPS)</label>
                <div id="speed" class="switch-group flex rounded-md bg-gray-900 p-1">
                    <button data-speed="7.5" class="flex-1 py-1 rounded text-sm">7.5</button>
                    <button data-speed="15"  class="flex-1 py-1 rounded text-sm active">15</button>
                    <button data-speed="30"  class="flex-1 py-1 rounded text-sm">30</button>
                </div>
            </div>

            <div>
                <label class="font-semibold mb-2 block">FLUXIVITY</label>
                <div id="flux" class="switch-group flex rounded-md bg-gray-900 p-1">
                    <button data-flux="185" class="flex-1 py-1 rounded text-sm">185</button>
                    <button data-flux="250" class="flex-1 py-1 rounded text-sm active">250</button>
                    <button data-flux="370" class="flex-1 py-1 rounded text-sm">370</button>
                </div>
            </div>

            <div>
                <label class="font-semibold mb-2 block">TAPE TYPE</label>
                <div id="tape" class="switch-group grid grid-cols-3 gap-1 bg-gray-900 p-1 rounded-md">
                    <button data-tapetype="406" class="py-1 rounded text-xs">406</button>
                    <button data-tapetype="456" class="py-1 rounded text-xs active">456</button>
                    <button data-tapetype="499" class="py-1 rounded text-xs">499</button>
                    <button data-tapetype="GP9" class="py-1 rounded text-xs">GP9</button>
                    <button data-tapetype="SM900" class="py-1 rounded text-xs">SM900</button>
                    <button data-tapetype="SM911" class="py-1 rounded text-xs">SM911</button>
                </div>
            </div>

        </div>

    </div> <!-- tech-panel -->

</div>

<script>
// =========================================
// REAL-TIME VU METER UPDATE FROM C++
// JUCE calls: window.setVUMeters(L, R)
// =========================================
window.setVUMeters = function (left, right) {
    const l = document.getElementById("vuL");
    const r = document.getElementById("vuR");
    if (!l || !r) return;

    // convert linear to dB
    const toDb = v => 20 * Math.log10(Math.max(v, 1e-9));

    const dbL = toDb(left);
    const dbR = toDb(right);

    const needle = db => {
        // -70 dB = far left, +20 dB = far right
        return Math.max(-70, Math.min(20, (db + 50) * 2.25 - 70));
    };

    l.style.transform = `rotate(${needle(dbL)}deg)`;
    r.style.transform = `rotate(${needle(dbR)}deg)`;
};

// ==========================
// KNOB + SWITCH JS (unchanged)
// ==========================
function $(id){ return document.getElementById(id); }
function safe(n,f=0){ const v=Number(n); return Number.isFinite(v)?v:f; }
function setActive(group,btn){ group.querySelectorAll("button").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); }

let state={inDb:0,outDb:0,bias:0,monitor:"input",speed:15,flux:250,eq:"NAB",tapeType:"456",headblock:"stereo"};

// Knob setup
function makeKnob(knobId,valId,key,min,max,fmt){
    const el=$(knobId), ind=el.querySelector(".knob-ind"), val=$(valId);
    let dragging=false,startY=0,startVal=0,pid=null;

    function setVal(v){
        const c=Math.min(max,Math.max(min,safe(v,0)));
        state[key]=Math.round(c*1000)/1000;
        const pct=(state[key]-min)/(max-min);
        ind.style.transform=`rotate(${270*pct-135}deg)`;
        val.textContent=fmt(state[key]);
        // JUCE will read state via JS if needed
    }
    setVal(state[key]??0);

    el.addEventListener("pointerdown",e=>{
        dragging=true; pid=e.pointerId; startY=e.clientY; startVal=safe(state[key],0);
        try{el.setPointerCapture(pid);}catch{};
        document.body.style.cursor="ns-resize";
        e.preventDefault();
    });
    el.addEventListener("pointermove",e=>{
        if(!dragging||(pid!==null&&e.pointerId!==pid))return;
        const dy=startY-e.clientY;
        setVal(startVal+(dy/150)*(max-min));
    });
    const end=e=>{
        if(!dragging||(pid!==null&&e.pointerId!==pid))return;
        dragging=false;
        try{el.releasePointerCapture(pid);}catch{};
        pid=null; document.body.style.cursor="default";
    };
    el.addEventListener("pointerup",end);
    el.addEventListener("pointercancel",end
